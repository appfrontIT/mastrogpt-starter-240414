<!DOCTYPE html>
<html lang="en">
<head>
<title>Walkiria Editor</title>
<style type="text/css" media="screen">
    *,
    *:before,
    *:after {
        margin: 0;
        padding: 0;
    }
    body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-image: var(--body-bg);
        font-family: Helvetica, sans-serif;
    }
    .msger {
        display: flex;
        flex-flow: column wrap;
        justify-content: space-between;
        width: 98%;
        height: 98%;
        border: none;
        border-radius: 5px;
    }
    .editor-cl {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        border: 2px solid grey;
        border-radius: 10px;
    }
    .buttons {
        display: flex;
        border-radius: 10px;
        background: #ffffff;
        position: relative;
        bottom: 1%;
    }
    .buttons * {
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        margin-right: 20px;
    }
    .button {
        background-color: white;
        color: violet;
        border: 2px solid violet;
        transition-duration: 0.4s;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1em;
    }

    button:hover {
        background-color: #e6e6e6;
        color: white;
    }
</style>
</head>
<body>
<section class="msger">
<main id="editor" class="editor-cl">Bot functionalities:
The bot is able to interact directly with your nuvolaris environment.
You can ask him to perform operations over actions, such as:

- Create functions ad deploy the action to call it.

- Actions generated by the bot already have a description about the function as annotation.
- They also have an annotations with 'key' parameters where there are the key and type of the function parameters

- Give you the actions list. The actions list will be given as: /{namespace}/{packagename}/{action}.

- Delete one action. Simply make the request like "delete {action}".

- If the action is part of a package specify the package({package}/{action}).

- It's possible to delete multiple action at a time, doing like "delete {action} {action} {action} {action}"

- Show additional information about one action:
    Just ask "{action} info" and you will get the action data and an explanation of the action.
    The bot can't produce information about a packed action, unless a description of the action is provided as annotation.

- You can ask the bot make an HTML page incorporating others actions.
  This is still in delevopment. Example: "Make an action returning an html page calling the following actions: {action1}, {action2}, {...}
</main>
<br>
<div class="buttons">
    <button type="submit" class="button" id="deploy" onclick="deploy()">deploy</button>
    <button type="submit" class="button" id="verify" onclick="verify()">verify</button>
</div>
</section>
<script src="/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    document.getElementById('editor').style.fontSize='12px';
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/twilight");
    editor.session.setMode("ace/mode/python");
    let base = location.href.replace(/code-editor\.html$/, "")

    let action = null

    async function get_function() {
       while(true) {
            try {
                let response = await fetch(base+'api/my/db/code_editor/get', {
                    headers: {"Content-Type": "application/json"},
                    method: 'POST',
                    credentials: 'include'
                })
                if (response.status == 200) {
                    const data = await response.json();
                    action = data;
                    editor.setValue(data['function']);
                }
            } catch(error) {
                console.log(error)
                return `ERROR interacting with ${this.url}`
            }
        }
    }

    window.onload = get_function

    async function deploy() {
        func = await editor.session.getValue()
        let cookie = document.cookie;
        split = cookie.split('=')
        const response = await fetch(base + 'api/my/default/auth/token', {
            method: 'GET',
            credentials: 'include'
        })
        if (response.status == 200) {
            data = await response.json();
            token = data['token'];
            upload = await fetch(base+'api/my/default/action/update', {
                headers: {"Content-Type": "application/json", "Authorization": "Bearer " + token},
                method: "PUT",
                body: JSON.stringify({
                    "name": action['name'],
                    "function": func,
                    "description": action['description'],
                    "namespace": action['namespace'],
                    "package": action['package']
                })
            })
            obj = await upload.json()
        }
    }

    async function verify() {
        // TO DO
    }

</script>
</body>
</html>