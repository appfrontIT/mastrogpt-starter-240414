<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/css/almond.min.css" />
    <link rel="stylesheet" href="/css/selector.css" />
    <link href="https://assets-global.website-files.com/5fb590162d25d5289824458f/5fb5a2895b6c6c97cc454ca8_icona.png" rel="shortcut icon" type="image/x-icon" data-cmp-ab="2" data-cmp-info="10">
</head>

<body>
    <div id="top-area">
        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a href="#" id="username"></a>
            <a href="#" id="namespace"></a>
            <a href="#" id="packages"></a>
            <a href="#" id="github"></a>
        </div>
        <button id="profile" onclick="profile()">Profile</button>
        <button id="lookinglass" onclick="lookinglass()">Lookinglass</button>
        <button id="coder" onclick="coder()">coder</button>
        <button id="admin" onclick="admin()">admin</button>
        <!-- <button id="test" onclick="test()">tester</button> -->
        <button id="logout" onclick="logout()">logout</button>
        <button id="swagger" onclick="swagger()">swagger</button>
        <button id="actions" onclick="actions()">actions</button>
        <button id="crawled" onclick="crawled()">crawled</button>
    </div>
    <div id="iframe-container" frameborder="0">
        <iframe id="chat" src="/chat.html" frameborder="0" width="40%" height="100%"></iframe>
        <iframe id="display" src="/display.html" frameborder="0" width="60%" height="100%"></iframe>
    </div>
    <script src="/js/selector.js"></script>
    <script>
        let chat = document.getElementById("chat").contentWindow
        let display = document.getElementById("display").contentWindow
        let base = location.href.replace(/selector\.html$/, "")
        let chat_frame = document.getElementById("chat")
        let display_frame = document.getElementById("display")
        
        document.addEventListener("DOMContentLoaded", async function(event) {
            event.preventDefault()
            let x = document.cookie;
            if (!x) {
                return window.location.assign('/index.html')
            }
            const token_response = await fetch(base + 'api/my/base/auth/token', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json'},
            })
            if (!token_response.ok) {
                document.cookie = 'appfront-sess-cookie=;expires=Thu, 01 Jan 1970 00:00:01 GMT'
                return window.location.assign('/index.html')
            } else {
                token_obj = await token_response.json()
                const user = await fetch(base + 'api/my/base/auth/user', {
                    method: 'GET',
                    headers: {"Authorization": "Bearer " + token_obj['token']}
                })
                if (user.status == 200) {
                    const user_obj = await user.json();
                    sessionStorage.setItem('user', JSON.stringify(user_obj));
                    document.getElementById('username').innerHTML = `username:<br>${user_obj['username']}`;
                    document.getElementById('namespace').innerHTML = `namespace:<br>${user_obj['namespace']}`;
                    document.getElementById('packages').innerHTML = `packages:<br>${user_obj['package']}`;
                }
            }
        })

        async function lookinglass() {
            // sessionStorage.setItem('url', base + "api/my/base/invoke/lookinglass")
            document.getElementById("display").src = 'https://appfront.cloud';
            chat.postMessage({url: base + "api/my/base/invoke/lookinglass"})
        }
        
        async function coder() {
            chat.postMessage({url: base + "api/my/base/invoke/walkiria"})
            // sessionStorage.setItem('url', base + "api/my/base/invoke/walkiria")
            document.getElementById("display").src = '/code-editor.html';
        }
        
        async function admin() {
            chat.postMessage({url: base + "api/my/base/invoke/admin"})
            // sessionStorage.setItem('url', base + "api/my/base/invoke/admin")
            document.getElementById("display").src = '/admin.html';
        }
        
        async function test() {
            chat.postMessage({url: base + "api/my/base/invoke/test"})
            // sessionStorage.setItem('url', base + "api/my/base/invoke/test")
            document.getElementById("display").src = '/display.html';
        }
        
        async function logout() {
            const response = await fetch(this.url, {
                method: 'DELETE',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json'},
            });
            document.cookie = 'appfront-sess-cookie=;expires=Thu, 01 Jan 1970 00:00:01 GMT'
            sessionStorage.clear()
            return window.parent.location.replace('/index.html')
        }

        async function profile() {
            document.getElementById("mySidenav").style.width = "250px";
            document.getElementById("chat").style.marginLeft = "250px";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.getElementById("chat").style.marginLeft= "0";
        }

        async function swagger() {
            document.getElementById("display").src = '/swagger.html'
        }

        async function actions() {
            chat.postMessage({url: base + "api/my/base/invoke/walkiria"})
            document.getElementById("display").src = '/actions.html'
        }

        async function crawled() {
            document.getElementById("display").src = '/crawled_pages.html'
        }
    </script>
</body>

</html>